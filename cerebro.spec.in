Name:    @PROJECT@ 
Version: @VERSION@
%if %{?_with_chaos:1}%{!?_with_chaos:0}
%if %{?_with_debug:1}%{!?_with_debug:0}
%define release @RELEASE@chaos.debug
%else
%define release @RELEASE@chaos
%endif
%else
%if %{?_with_debug:1}%{!?_with_debug:0}
%define release @RELEASE@.debug
%else
%define release @RELEASE@
%endif
%endif

Summary: Cerebro cluster monitoring tools and libraries
Group: System Environment/Base
License: GPL
Source: @PROJECT@-@VERSION@-@RELEASE@.tgz
BuildRoot: %{_tmppath}/@PROJECT@-@VERSION@-@RELEASE@
%if %{?_with_chaos:1}%{!?_with_chaos:0}
Requires: gendersllnl
Requires: genders >= 1.4
Conflicts: ganglia-monitor-core
%endif

%description
Cerebro is a collection of cluster monitoring tools and libraries.

%if %{?_with_chaos:1}%{!?_with_chaos:0}
%define _with_gendersllnl    --with-gendersllnl
%define _without_genders     --without-genders
%define _without_hostsfile   --without-hostsfile
%define _without_slurm_state --without-slurm-state
%ifarch ia64
%define _with_boottime       --with-boottime
%define _with_bootlog        --with-bootlog
%else
%define _without_boottime    --without-boottime
%define _without_bootlog     --without-bootlog
%endif
%else
%{!?_with_gendersllnl: %{!?_without_gendersllnl: %define _with_gendersllnl --with-gendersllnl}}
%{!?_with_genders: %{!?_without_genders: %define _with_genders --with-genders}}
%{!?_with_hostsfile: %{!?_without_hostsfile: %define _with_hostsfile --with-hostsfile}}
%{!?_with_boottime: %{!?_without_boottime: %define _with_boottime --with-boottime}}
%{!?_with_bootlog: %{!?_without_bootlog: %define _without_bootlog --without-bootlog}}
%endif

%if %{?_with_debug:1}%{!?_with_debug:0}
%define _enable_debug --enable-debug
%endif

%package gendersllnl
Summary: gendersllnl module(s)
Group: System Environment/Base
Requires: cerebro
Requires: gendersllnl
%description gendersllnl
Gendersllnl module(s).

%package genders
Summary: genders module(s)
Group: System Environment/Base
Requires: cerebro
Requires: genders >= 1.2
%description genders
Genders module(s).

%package hostsfile
Summary: hostsfile module(s)
Group: System Environment/Base
Requires: cerebro
%description hostsfile
Hostsfile module(s).

%package metric-boottime
Summary: boottime module(s)
Group: System Environment/Base
Requires: cerebro
%description metric-boottime
Metric module to monitor boottime.

%package metric-slurm-state
Summary: slurm_state module(s)
Group: System Environment/Base
Requires: cerebro
%description metric-slurm-state
Metric module to monitor slurm_state.

%if %{?_with_chaos:1}%{!?_with_chaos:0}
%package bootlog
Summary: bootlog module(s)
Group: System Environment/Base
Requires: cerebro
Requires: qsqsql
%description bootlog
Bootlog monitoring module(s).
%endif

%prep
%setup  -q -n @PROJECT@-@VERSION@-@RELEASE@

%build
%configure --program-prefix=%{?_program_prefix:%{_program_prefix}} \
           %{?_with_gendersllnl} \
           %{?_without_gendersllnl} \
           %{?_with_genders} \
           %{?_without_genders} \
           %{?_with_hostsfile} \
           %{?_without_hostsfile} \
           %{?_with_boottime} \
           %{?_without_boottime} \
           %{?_with_slurm_state} \
           %{?_without_slurm_state} \
           %{?_with_bootlog} \
           %{?_without_bootlog} \
           %{?_enable_debug}
make 

%install
rm -rf $RPM_BUILD_ROOT
DESTDIR="$RPM_BUILD_ROOT" make install

%post
#
# Restart cerebrod if already running
#
if [ "$1" = 1 ]; then
   if [ -x /etc/init.d/cerebrod ]; then
      [ -x /sbin/chkconfig ] && /sbin/chkconfig --add cerebrod
   fi
fi
if [ $1 -ge 1 ]; then
   if [ -x /etc/init.d/cerebrod ]; then
      /etc/init.d/cerebrod condrestart
   fi
fi

%preun
#
# Stop cerebrod if it is running
#
if [ "$1" = 0 ]; then
    if [ -x /etc/init.d/cerebrod ]; then
       if /etc/init.d/cerebrod status | grep -q running; then
          /etc/init.d/cerebrod stop
       fi
       [ -x /sbin/chkconfig ] && /sbin/chkconfig --del cerebrod
    fi
fi

%files
%defattr(-,root,root)
%doc README NEWS ChangeLog 
%config(noreplace) %{_sysconfdir}/init.d/cerebrod
%{_sbindir}/*
%{_includedir}/*
%{_libdir}/libcerebro*
%{_mandir}/*
%if %{?_with_chaos:1}%{!?_with_chaos:0}
%{_libdir}/cerebro/cerebro_clusterlist*
%{_libdir}/cerebro/cerebro_config*
%endif

%if %{?_with_chaos:0}%{!?_with_chaos:1}

%if %{?_with_gendersllnl:1}%{!?_with_gendersllnl:0}
%files gendersllnl
%defattr(-,root,root)
%{_libdir}/cerebro/cerebro_clusterlist_gendersllnl.*
%{_libdir}/cerebro/cerebro_config_gendersllnl.*
%endif

%if %{?_with_genders:1}%{!?_with_genders:0}
%files genders
%defattr(-,root,root)
%{_libdir}/cerebro/cerebro_clusterlist_genders.*
%endif

%if %{?_with_hostsfile:1}%{!?_with_hostsfile:0}
%files hostsfile
%defattr(-,root,root)
%{_libdir}/cerebro/cerebro_clusterlist_hostsfile.*
%endif

%if %{?_with_boottime:1}%{!?_with_boottime:0}
%files metric-boottime
%defattr(-,root,root)
%{_libdir}/cerebro/cerebro_metric_boottime.*
%endif

%if %{?_with_slurm_state:1}%{!?_with_slurm_state:0}
%files metric-slurm-state
%defattr(-,root,root)
%{_libdir}/cerebro/cerebro_metric_slurm-state.*
%endif

%endif

%if %{?_with_chaos:1}%{!?_with_chaos:0}
%if %{?_with_bootlog:1}%{!?_with_bootlog:0}
%files bootlog
%defattr(-,root,root)
%{_libdir}/cerebro/cerebro_metric_boottime.*
%{_libdir}/cerebro/cerebro_monitor_bootlog.*
%endif
%endif
