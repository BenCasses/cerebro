Name:    @PROJECT@ 
Version: @VERSION@
%if %{?_with_chaos:1}%{!?_with_chaos:0}
%if %{?_with_debug:1}%{!?_with_debug:0}
Release: @RELEASE@chaos.debug
%else
Release: @RELEASE@chaos
%endif
%endif
%if %{?_with_bgl:1}%{!?_with_bgl:0} 
%if %{?_with_debug:1}%{!?_with_debug:0}
Release: @RELEASE@bgl.debug
%else
Release: @RELEASE@bgl
%endif
%endif
%if %{?_with_bglion:1}%{!?_with_bglion:0}
%if %{?_with_debug:1}%{!?_with_debug:0}
Release: @RELEASE@bglion.debug
%else
Release: @RELEASE@bglion
%endif
%endif
%if %{?_with_chaos:0}%{!?_with_chaos:1}
%if %{?_with_bgl:0}%{!?_with_bgl:1} 
%if %{?_with_debug:1}%{!?_with_debug:0} 
Release: @RELEASE@.debug
%else 
Release: @RELEASE@
%endif
%endif
%endif

Summary: Cerebro cluster monitoring tools and libraries
Group: System Environment/Base
License: GPL
Source: @PROJECT@-@VERSION@-@RELEASE@.tgz
BuildRoot: %{_tmppath}/@PROJECT@-@VERSION@-@RELEASE@
%if %{?_with_chaos:1}%{!?_with_chaos:0}
Requires: gendersllnl
Requires: genders >= 1.4
Conflicts: ganglia-monitor-core
%endif

%description
Cerebro is a collection of cluster monitoring tools and libraries.

#
# Special build for LLNL Linux CHAOS clusters
#
%if %{?_with_chaos:1}%{!?_with_chaos:0}
%define _with_gendersllnl           --with-gendersllnl
%define _without_genders            --without-genders
%define _without_hostsfile          --without-hostsfile
%define _with_chaos_config          --with-chaos-config
%define _without_bgl_config         --without-bgl-config
%define _without_slurm_state        --without-slurm-state
%define _without_bgl_ciod           --without-bgl-ciod
%ifarch ia64
%define _with_boottime              --with-boottime
%define _with_bootlog               --with-bootlog
%else
%define _without_boottime           --without-boottime
%define _without_bootlog            --without-bootlog
%endif
%endif

#
# Special build for BlueGene/L front end nodes
#
%if %{?_with_bgl:1}%{!?_with_bgl:0} 
%define _without_gendersllnl        --without-gendersllnl
%define _without_genders            --without-genders
%define _without_hostsfile          --without-hostsfile
%define _without_chaos_config       --without-chaos-config
%define _with_bgl_config            --with-bgl-config
%define _without_boottime           --without-boottime
%define _without_slurm_state        --without-slurm-state
%define _without_bgl_ciod           --without-bgl-ciod
%define _without_bootlog            --without-bootlog
%endif

#
# Special build for BlueGene/L ion nodes
#
%if %{?_with_bglion:1}%{!?_with_bglion:0} 
%define _without_gendersllnl        --without-gendersllnl
%define _without_genders            --without-genders
%define _without_hostsfile          --without-hostsfile
%define _without_chaos_config       --without-chaos-config
%define _with_bgl_config            --with-bgl-config
%define _without_boottime           --without-boottime
%define _without_slurm_state        --without-slurm-state
%define _with_bgl_ciod              --with-bgl-ciod
%define _without_bootlog            --without-bootlog
%define _with_cerebrod_speaker_only --with-cerebrod-speaker-only
%define _with_cerebrod_no_threads   --with-cerebrod-no-threads
%define _with_cerebro_config_file   --with-cerebro-config-file=/bgl/ion/etc/cerebro.conf
%define _with_bgl_ciod_config_file  --with-bgl-ciod-config-file=/bgl/ion/etc/cerebro_bgl_ciod.conf
%define _enable_static_modules      --enable-static-modules
%endif

%if %{?_with_chaos:0}%{!?_with_chaos:1}
%if %{?_with_bgl:0}%{!?_with_bgl:1} 
%if %{?_with_bglion:0}%{!?_with_bglion:1} 
%{!?_with_gendersllnl: %{!?_without_gendersllnl: %define _with_gendersllnl --with-gendersllnl}}
%{!?_with_genders: %{!?_without_genders: %define _with_genders --with-genders}}
%{!?_with_hostsfile: %{!?_without_hostsfile: %define _with_hostsfile --with-hostsfile}}
%{!?_with_chaos_config: %{!?_without_chaos_config: %define _with_chaos_config --with-chaos-config}}
%{!?_with_bgl_config: %{!?_without_bgl_config: %define _with_bgl_config --with-bgl-config}}
%{!?_with_boottime: %{!?_without_boottime: %define _with_boottime --with-boottime}}
%{!?_with_slurm_state: %{!?_without_slurm_state: %define _without_slurm_state --without-slurm-state}}
%{!?_with_bgl_ciod: %{!?_without_bgl_ciod: %define _without_bgl_ciod --without-bgl-ciod}}
%{!?_with_bootlog: %{!?_without_bootlog: %define _without_bootlog --without-bootlog}}
%endif
%endif

%if %{?_with_debug:1}%{!?_with_debug:0}
%define _enable_debug --enable-debug
%endif

%package clusterlist-gendersllnl
Summary: clusterlist gendersllnl module
Group: System Environment/Base
Requires: cerebro
Requires: gendersllnl
%description clusterlist-gendersllnl
Gendersllnl module

%package clusterlist-genders
Summary: clusterlist genders module
Group: System Environment/Base
Requires: cerebro
Requires: genders >= 1.2
%description clusterlist-genders
Genders module

%package clusterlist-hostsfile
Summary: clusterlist hostsfile module
Group: System Environment/Base
Requires: cerebro
%description clusterlist-hostsfile
Hostsfile module

%package config-chaos
Summary: config-chaos module
Group: System Environment/Base
Requires: cerebro
%description config-chaos
Config module for chaos.

%package config-bgl
Summary: config-bgl module
Group: System Environment/Base
Requires: cerebro
%description config-bgl
Config module for bgl.

%package metric-boottime
Summary: boottime module
Group: System Environment/Base
Requires: cerebro
%description metric-boottime
Metric module to monitor boottime.

%package metric-slurm-state
Summary: slurm_state module
Group: System Environment/Base
Requires: cerebro
%description metric-slurm-state
Metric module to monitor slurm_state.

%package metric-bgl-ciod
Summary: bgl_ciod module
Group: System Environment/Base
Requires: cerebro
%description metric-bgl-ciod
Metric module to monitor bgl_ciod.

%package bootlog
Summary: bootlog module
Group: System Environment/Base
Requires: cerebro
Requires: qsqsql
%description bootlog
Bootlog monitoring module.

%prep
%setup  -q -n @PROJECT@-@VERSION@-@RELEASE@

%build
%configure --program-prefix=%{?_program_prefix:%{_program_prefix}} \
           %{?_with_gendersllnl} \
           %{?_without_gendersllnl} \
           %{?_with_genders} \
           %{?_without_genders} \
           %{?_with_hostsfile} \
           %{?_without_hostsfile} \
           %{?_with_chaos_config} \
           %{?_without_chaos_config} \
           %{?_with_bgl_config} \
           %{?_without_bgl_config} \
           %{?_with_boottime} \
           %{?_without_boottime} \
           %{?_with_slurm_state} \
           %{?_without_slurm_state} \
           %{?_with_bgl_ciod} \
           %{?_without_bgl_ciod} \
           %{?_with_bootlog} \
           %{?_without_bootlog} \
           %{?_with_cerebrod_speaker_only} \
           %{?_without_cerebrod_speaker_only} \
           %{?_with_cerebrod_no_threads} \
           %{?_without_cerebrod_no_threads} \
           %{?_with_cerebro_config_file} \
           %{?_with_bgl_ciod_config_file} \
           %{?_enable_static_modules} \
           %{?_enable_debug}
make 

%install
rm -rf $RPM_BUILD_ROOT
DESTDIR="$RPM_BUILD_ROOT" make install

%post
#
# Restart cerebrod if already running
#
if [ "$1" = 1 ]; then
   if [ -x /etc/init.d/cerebrod ]; then
      [ -x /sbin/chkconfig ] && /sbin/chkconfig --add cerebrod
   fi
fi
if [ $1 -ge 1 ]; then
   if [ -x /etc/init.d/cerebrod ]; then
      /etc/init.d/cerebrod condrestart
   fi
fi

%preun
#
# Stop cerebrod if it is running
#
if [ "$1" = 0 ]; then
    if [ -x /etc/init.d/cerebrod ]; then
       if /etc/init.d/cerebrod status | grep -q running; then
          /etc/init.d/cerebrod stop
       fi
       [ -x /sbin/chkconfig ] && /sbin/chkconfig --del cerebrod
    fi
fi

%files
%defattr(-,root,root)
%doc README NEWS ChangeLog DISCLAIMER COPYING
%config(noreplace) %{_sysconfdir}/init.d/cerebrod
%{_includedir}/*
%{_libdir}/libcerebro*
%{_mandir}/*
%{_sbindir}/cerebrod
%{_sbindir}/cerebro-stat
%{_sbindir}/cerebro-admin
%if %{?_with_chaos:1}%{!?_with_chaos:0}
%{_libdir}/cerebro/cerebro_clusterlist*
%{_libdir}/cerebro/cerebro_config*
%endif
%if %{?_with_bgl:1}%{!?_with_bgl:0} 
%{_libdir}/cerebro/cerebro_config*
%endif
%if %{?_with_bglion:1}%{!?_with_bglion:0} 
%{_libdir}/cerebro/cerebro_config*
%{_libdir}/cerebro/cerebro_metric*
%endif

%if %{?_with_chaos:0}%{!?_with_chaos:1}
%if %{?_with_bgl:0}%{!?_with_bgl:1} 

%if %{?_with_gendersllnl:1}%{!?_with_gendersllnl:0}
%files clusterlist-gendersllnl
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_clusterlist_gendersllnl.*
%endif

%if %{?_with_genders:1}%{!?_with_genders:0}
%files clusterlist-genders
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_clusterlist_genders.*
%endif

%if %{?_with_hostsfile:1}%{!?_with_hostsfile:0}
%files clusterlist-hostsfile
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_clusterlist_hostsfile.*
%endif

%if %{?_with_chaos_config:1}%{!?_with_chaos_config:0}
%files config-chaos
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_config_chaos.*
%endif

%if %{?_with_bgl_config:1}%{!?_with_bgl_config:0}
%files config-bgl
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_config_bgl.*
%endif

%if %{?_with_boottime:1}%{!?_with_boottime:0}
%files metric-boottime
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_metric_boottime.*
%endif

%if %{?_with_slurm_state:1}%{!?_with_slurm_state:0}
%files metric-slurm-state
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_metric_slurm_state.*
%endif

%if %{?_with_bgl_ciod:1}%{!?_with_bgl_ciod:0}
%files metric-bgl-ciod
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_metric_bgl_ciod.*
%endif

%if %{?_with_bootlog:1}%{!?_with_bootlog:0}
%files monitor-bootlog
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_monitor_bootlog.*
%endif

%endif
%endif

%if %{?_with_chaos:1}%{!?_with_chaos:0}
%if %{?_with_bootlog:1}%{!?_with_bootlog:0}
%files bootlog
%defattr(700,root,root)
%{_libdir}/cerebro/cerebro_metric_boottime.*
%{_libdir}/cerebro/cerebro_monitor_bootlog.*
%endif
%endif
